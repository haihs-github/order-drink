<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>H·ªá Th·ªëng Qu·∫£n L√Ω</title>
    <link rel="stylesheet" href="../assets/css/htql1.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
      integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link
      rel="stylesheet"
      href="../assets/font/themify-icons/themify-icons.css"
    />
  </head>
  <body>
    <header class="header">
      <div class="logo">
        <span>&#9776; He Thong QuanLy</span>
      </div>
      <div class="admin">
        <span>&#128100; ADMIN</span>
      </div>
    </header>

    <div class="container">
      <aside class="sidebar">
        <ul>
          <li><a href="quanli-sanpham.html">üìÇ Qu·∫£n l√Ω s·∫£n ph·∫©m</a></li>
          <li><a href="quanli-donhang.html">üì¶ Qu·∫£n l√Ω ƒë∆°n h√†ng</a></li>
          <li><a href="quanli-khachhang.html">üë• Qu·∫£n l√Ω kh√°ch h√†ng</a></li>
          <li><a href="quanli-taikhoan.html">üîë Qu·∫£n l√Ω t√†i kho·∫£n</a></li>
          <li><a href="quanli-tintuc.html">üîë Qu·∫£n l√Ω tin t·ª©c</a></li>
        </ul>
      </aside>

      <main class="main-content">
        <h2>QU·∫¢N L√ç S·∫¢N PH·∫®M</h2>
        <button id="add-product">Th√™m S·∫£n Ph·∫©m</button>
        <table>
          <thead>
            <tr>
              <th>STT</th>
              <th>T√™n s·∫£n ph·∫©m</th>
              <th>Lo·∫°i s·∫£n ph·∫©m</th>
              <th>ƒê∆°n gi√°</th>
              <th>gi·∫£m gi√°</th>
              <th>m√¥ t·∫£</th>
              <th>H√¨nh ·∫£nh</th>
              <th>H√†nh ƒë·ªông</th>
            </tr>
          </thead>
          <tbody id="product-list"></tbody>
        </table>
      </main>
    </div>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const productList = document.getElementById("product-list");
        const addProductButton = document.getElementById("add-product");
        let productIdCounter = 1;
        const adminToken = localStorage.getItem("authToken"); // S·ª≠ d·ª•ng localStorage ƒë·ªÉ l∆∞u tr·ªØ token

        // H√†m ki·ªÉm tra quy·ªÅn admin v√† chuy·ªÉn h∆∞·ªõng n·∫øu kh√¥ng ph·∫£i admin
        function checkAdminRole() {
          if (!adminToken) {
            alert(
              "B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y. Vui l√≤ng ƒëƒÉng nh·∫≠p v·ªõi t√†i kho·∫£n qu·∫£n tr·ªã."
            );
            window.location.href = "login.html"; // Chuy·ªÉn ƒë·∫øn trang ƒëƒÉng nh·∫≠p
            return false; // NgƒÉn ch·∫∑n t·∫£i trang n·∫øu kh√¥ng ph·∫£i admin
          }
          // Th√™m ƒëo·∫°n code ki·ªÉm tra token v·ªõi backend n·∫øu c·∫ßn (v√≠ d·ª•: g·ª≠i y√™u c·∫ßu fetch)
          // V√≠ d·ª•:
          // fetch("/api/check-admin", {
          //   method: "GET",
          //   headers: {
          //     Authorization: `Bearer ${adminToken}`,
          //   },
          // })
          // .then(response => response.json())
          // .then(data => {
          //   if (!data.isAdmin) {
          //     alert("B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y.");
          //     window.location.href = "login.html";
          //   }
          // })
          // .catch(error => {
          //   console.error("L·ªói ki·ªÉm tra quy·ªÅn:", error);
          //   alert("C√≥ l·ªói x·∫£y ra khi ki·ªÉm tra quy·ªÅn.");
          //   window.location.href = "login.html"; // Chuy·ªÉn h∆∞·ªõng ƒë·ªÉ ƒë·∫£m b·∫£o an to√†n
          // });

          return true; // Cho ph√©p t·∫£i trang n·∫øu l√† admin
        }

        // Ki·ªÉm tra quy·ªÅn admin tr∆∞·ªõc khi t·∫£i trang
        if (!checkAdminRole()) {
          return;
        }

        function renderProduct(product) {
          const newRow = document.createElement("tr");
          newRow.innerHTML = `
              <td>${productIdCounter++}</td>
              <td contenteditable="false" class="name">${product.title}</td>
              <td contenteditable="false" class="category">${
                product.category_id ? product.category_id.name : "Ch∆∞a c√≥"
              }</td>
              <td contenteditable="false" class="price">${product.price}</td>
              <td contenteditable="false" class="discount">${
                product.discount
              }</td>
              <td contenteditable="false" class="description">${
                product.description
              }</td>
              <td><img src="${product.thumbnail || "img.png"}" alt="${
            product.title
          }" width="50"></td>
              <td>
                  <button class="edit">S·ª≠a</button>
                  <button class="save" style="display: none;">L∆∞u</button>
                  <button class="delete">X√≥a</button>
              </td>
          `;
          productList.appendChild(newRow);
          addEventListeners(newRow, product._id);
        }

        function addEventListeners(row, productId) {
          const deleteButton = row.querySelector(".delete");
          const editButton = row.querySelector(".edit");
          const saveButton = row.querySelector(".save");
          const nameCell = row.querySelector(".name");
          const categoryCell = row.querySelector(".category");
          const priceCell = row.querySelector(".price");
          const discountCell = row.querySelector(".discount");
          const descriptionCell = row.querySelector(".description");
          const imageCell = row.querySelector("td:nth-child(7) img");
          const imageInput = document.createElement("input");
          imageInput.type = "file";
          imageInput.accept = "image/*";
          imageInput.style.display = "none";

          row.querySelector("td:nth-child(7)").appendChild(imageInput);

          imageInput.addEventListener("change", (event) => {
            const file = event.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = (e) => {
                imageCell.src = e.target.result;
              };
              reader.readAsDataURL(file);
            }
          });

          deleteButton.addEventListener("click", function () {
            const confirmDelete = confirm(
              "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a s·∫£n ph·∫©m n√†y kh√¥ng?"
            );
            if (confirmDelete) {
              fetch(`http://localhost:5000/api/products/${productId}`, {
                method: "DELETE",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${adminToken}`,
                },
              })
                .then((response) => {
                  if (response.ok) {
                    row.remove();
                    alert("S·∫£n ph·∫©m ƒë√£ ƒë∆∞·ª£c x√≥a.");
                  } else {
                    return response.json().then((data) => {
                      throw new Error(
                        `L·ªói x√≥a s·∫£n ph·∫©m: ${data.message || "C√≥ l·ªói x·∫£y ra."}`
                      );
                    });
                  }
                })
                .catch((error) => {
                  console.error("L·ªói khi g·ªçi API x√≥a s·∫£n ph·∫©m:", error);
                  alert(error.message || "L·ªói khi x√≥a s·∫£n ph·∫©m."); // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói cho ng∆∞·ªùi d√πng
                });
            }
          });

          editButton.addEventListener("click", function () {
            nameCell.contentEditable = "true";
            categoryCell.contentEditable = "true";
            priceCell.contentEditable = "true";
            discountCell.contentEditable = "true";
            descriptionCell.contentEditable = "true";
            imageInput.style.display = "block";
            editButton.style.display = "none";
            saveButton.style.display = "inline-block";
          });

          saveButton.addEventListener("click", function () {
            const updatedProductData = {
              title: nameCell.textContent,
              category: categoryCell.textContent,
              price: parseInt(priceCell.textContent),
              discount: parseInt(discountCell.textContent),
              description: descriptionCell.textContent,
            };

            const formData = new FormData();
            for (const key in updatedProductData) {
              formData.append(key, updatedProductData[key]);
            }

            if (imageInput && imageInput.files[0]) {
              formData.append("thumbnail", imageInput.files[0]);
            }

            fetch(`http://localhost:5000/api/products/${productId}`, {
              method: "PUT",
              body: formData,
              headers: {
                Authorization: `Bearer ${adminToken}`,
              },
            })
              .then((response) => {
                if (response.ok) {
                  return response.json();
                } else {
                  return response.json().then((data) => {
                    throw new Error(
                      `L·ªói c·∫≠p nh·∫≠t s·∫£n ph·∫©m: ${
                        data.message || "C√≥ l·ªói x·∫£y ra."
                      }`
                    );
                  });
                }
              })
              .then((updatedProduct) => {
                alert("Th√¥ng tin s·∫£n ph·∫©m ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t.");
                if (updatedProduct.thumbnail) {
                  imageCell.src = updatedProduct.thumbnail;
                }
                nameCell.contentEditable = "false";
                categoryCell.contentEditable = "false";
                priceCell.contentEditable = "false";
                discountCell.contentEditable = "false";
                descriptionCell.contentEditable = "false";
                imageInput.style.display = "none";
                saveButton.style.display = "none";
                editButton.style.display = "inline-block";
              })
              .catch((error) => {
                console.error("L·ªói khi g·ªçi API c·∫≠p nh·∫≠t s·∫£n ph·∫©m:", error);
                // alert("L·ªói khi c·∫≠p nh·∫≠t s·∫£n ph·∫©m.22"); // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói
              });
          });
        }

        addProductButton.addEventListener("click", function () {
          const newRow = document.createElement("tr");
          newRow.innerHTML = `
              <td>${productIdCounter++}</td>
              <td contenteditable="true" class="name">Nh·∫≠p t√™n</td>
              <td contenteditable="true" class="category">Nh·∫≠p lo·∫°i</td>
              <td contenteditable="true" class="price">Nh·∫≠p gi√°</td>
              <td contenteditable="true" class="discount">gi·∫£m gi√°...</td>
              <td contenteditable="true" class="description">Nh·∫≠p m√¥ t·∫£</td>
              <td><img src="img.png" alt="New" width="50"><input type="file" accept="image/*"></td>
              <td>
                  <button class="edit" style="display: none;">S·ª≠a</button>
                  <button class="save-new">L∆∞u M·ªõi</button>
                  <button class="delete">X√≥a</button>
              </td>
          `;
          productList.appendChild(newRow);

          const saveNewButton = newRow.querySelector(".save-new");
          const deleteNewButton = newRow.querySelector(".delete");
          const nameCell = newRow.querySelector(".name");
          const categoryCell = newRow.querySelector(".category");
          const priceCell = newRow.querySelector(".price");
          const discountCell = newRow.querySelector(".discount");
          const descriptionCell = newRow.querySelector(".description");
          const imageInput = newRow.querySelector('input[type="file"]');
          const imageCell = newRow.querySelector("td:nth-child(7) img");

          imageInput.addEventListener("change", (event) => {
            const file = event.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = (e) => {
                imageCell.src = e.target.result;
              };
              reader.readAsDataURL(file);
            }
          });

          saveNewButton.addEventListener("click", function () {
            const newProductData = {
              title: nameCell.textContent,
              category: categoryCell.textContent,
              price: parseInt(priceCell.textContent),
              discount: parseInt(discountCell.textContent),
              description: descriptionCell.textContent,
            };

            const formData = new FormData();
            for (const key in newProductData) {
              formData.append(key, newProductData[key]);
            }

            if (imageInput && imageInput.files[0]) {
              formData.append("thumbnail", imageInput.files[0]);
            }

            fetch("http://localhost:5000/api/products", {
              method: "POST",
              body: formData,
              headers: {
                Authorization: `Bearer ${adminToken}`,
              },
            })
              .then((response) => {
                if (response.status === 201) {
                  return response.json();
                } else {
                  return response.json().then((data) => {
                    throw new Error(
                      `L·ªói th√™m s·∫£n ph·∫©m: ${data.message || "C√≥ l·ªói x·∫£y ra."}`
                    );
                  });
                }
              })
              .then((newProduct) => {
                alert("S·∫£n ph·∫©m ƒë√£ ƒë∆∞·ª£c th√™m th√†nh c√¥ng.");
                productList.innerHTML = ""; // Clear the product list
                productIdCounter = 1; // Reset the product counter
                fetch("http://localhost:5000/api/products", {
                  headers: {
                    Authorization: `Bearer ${adminToken}`,
                  },
                })
                  .then((response) => response.json())
                  .then((products) => {
                    const filteredProducts = products.filter(
                      (product) => !product.deleted
                    );
                    filteredProducts.forEach((product) =>
                      renderProduct(product)
                    );
                  })
                  .catch((error) => {
                    console.error("L·ªói khi g·ªçi API l·∫•y s·∫£n ph·∫©m:", error);
                    alert("Kh√¥ng th·ªÉ t·∫£i danh s√°ch s·∫£n ph·∫©m.");
                  });
              })
              .catch((error) => {
                console.error("L·ªói khi g·ªçi API th√™m s·∫£n ph·∫©m:", error);
                alert(error.message || "L·ªói khi th√™m s·∫£n ph·∫©m."); // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói
              });
          });

          deleteNewButton.addEventListener("click", function () {
            const confirmDelete = confirm(
              "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a s·∫£n ph·∫©m m·ªõi n√†y kh√¥ng?"
            );
            if (confirmDelete) {
              newRow.remove();
            }
          });
        });

        // Fetch product list on page load
        fetch("http://localhost:5000/api/products", {
          headers: {
            Authorization: `Bearer ${adminToken}`,
          },
        })
          .then((response) => response.json())
          .then((products) => {
            const filteredProducts = products.filter(
              (product) => !product.deleted
            );
            filteredProducts.forEach((product) => renderProduct(product));
          })
          .catch((error) => {
            console.error("L·ªói khi g·ªçi API l·∫•y s·∫£n ph·∫©m:", error);
            alert("Kh√¥ng th·ªÉ t·∫£i danh s√°ch s·∫£n ph·∫©m.");
          });
      });
    </script>
  </body>
</html>

<!-- //done -->
